apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"
apply plugin: "com.google.gms.google-services"
apply from: project(':react-native-config').projectDir.getPath() + "/dotenv.gradle"
apply from: file("../../node_modules/react-native-vector-icons/fonts.gradle")

/**
 * This is the configuration block to customize your React Native Android app.
 * By default you don't need to apply any configuration, just uncomment the lines you need.
 */
react {
    /* Variants */
    // List debuggable variants for all flavors
    debuggableVariants = ["bsschoolDebug", "crescentDebug", "psseniorDebug", "railwaybalabhavanDebug"]

    /* Autolinking */
    autolinkLibrariesWithApp()
}

/**
 * Environment file mapping for react-native-config
 * Maps each flavor+buildType combination to its environment file
 */
project.ext.envConfigFiles = [
    bsschooldebug: "../../brands/bsschool/env/.env.development",
    bsschoolrelease: "../../brands/bsschool/env/.env.production",
    crescentdebug: "../../brands/crescent/env/.env.development",
    crescentrelease: "../../brands/crescent/env/.env.production",
    psseniordebug: "../../brands/pssenior/env/.env.development",
    psseniorrelease: "../../brands/pssenior/env/.env.production",
    railwaybalabhavandebug: "../../brands/railwaybalabhavan/env/.env.development",
    railwaybalabhavanrelease: "../../brands/railwaybalabhavan/env/.env.production",
]

/**
 * Set this to true to Run Proguard on Release builds to minify the Java bytecode.
 */
def enableProguardInReleaseBuilds = false

/**
 * The preferred build flavor of JavaScriptCore (JSC)
 *
 * For example, to use the international variant, you can use:
 * `def jscFlavor = io.github.react-native-community:jsc-android-intl:2026004.+`
 *
 * The international variant includes ICU i18n library and necessary data
 * allowing to use e.g. `Date.toLocaleString` and `String.localeCompare` that
 * give correct results when using with locales other than en-US. Note that
 * this variant is about 6MiB larger per architecture than default.
 */
def jscFlavor = 'io.github.react-native-community:jsc-android:2026004.+'

android {
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace "com.schooltree.parentapp"

    defaultConfig {
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"

        // Default BuildConfig fields (overridden by flavors)
        buildConfigField "String", "BRAND_ID", "\"crescent\""
        buildConfigField "String", "AUTH_TYPE", "\"password\""
        buildConfigField "String", "DB_NAME", "\"crescent_db\""
    }

    /**
     * Product Flavors - White-label configuration for different schools
     * Each flavor creates a separate app with its own:
     * - Application ID (package name)
     * - App name
     * - Brand configuration
     */
    flavorDimensions "brand"

    productFlavors {
        // B.S Nursery & Primary School
        bsschool {
            dimension "brand"
            applicationId "com.schooltree.bs"
            resValue "string", "app_name", "B.S Nursery & Primary School Parent"
            buildConfigField "String", "BRAND_ID", "\"bsschool\""
            buildConfigField "String", "AUTH_TYPE", "\"otp\""
            buildConfigField "String", "DB_NAME", "\"bs_school\""
        }

        // Crescent Matriculation Girls Hr. Sec. School
        crescent {
            dimension "brand"
            applicationId "com.schooltree.crescentapp"
            resValue "string", "app_name", "Crescent Matriculation Girls Hr. Sec. School Parent"
            buildConfigField "String", "BRAND_ID", "\"crescent\""
            buildConfigField "String", "AUTH_TYPE", "\"otp\""
            buildConfigField "String", "DB_NAME", "\"cresent\""
        }

        // P.S. Senior Secondary School
        pssenior {
            dimension "brand"
            applicationId "com.schooltree.pssenior"
            resValue "string", "app_name", "P.S. Senior Secondary School Parent"
            buildConfigField "String", "BRAND_ID", "\"pssenior\""
            buildConfigField "String", "AUTH_TYPE", "\"password\""
            buildConfigField "String", "DB_NAME", "\"pssenior\""
        }

        // Reilway Bala Bhavan School
        railwaybalabhavan {
            dimension "brand"
            applicationId "com.schooltree.balabhavan"
            resValue "string", "app_name", "Reilway Bala Bhavan School Parent"
            buildConfigField "String", "BRAND_ID", "\"railwaybalabhavan\""
            buildConfigField "String", "AUTH_TYPE", "\"otp\""
            buildConfigField "String", "DB_NAME", "\"rlybalabhavans\""
        }

        // Add more school flavors using: npm run school:add
    }

    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        // Add release signing configs per brand as needed
        // crescentRelease {
        //     storeFile file('keystores/crescent.keystore')
        //     storePassword System.getenv("CRESCENT_STORE_PASSWORD")
        //     keyAlias 'crescent'
        //     keyPassword System.getenv("CRESCENT_KEY_PASSWORD")
        // }
    }

    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            // Caution! In production, you need to generate your own keystore file.
            // see https://reactnative.dev/docs/signed-apk-android.
            signingConfig signingConfigs.debug
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }

    /**
     * Source sets for brand-specific resources
     * Each brand can have its own icons, colors, and other resources
     * Place resources in: android/app/src/{brandName}/res/
     */
    sourceSets {
        bsschool {
            res.srcDirs = ['src/bsschool/res']
        }
        crescent {
            res.srcDirs = ['src/crescent/res']
        }
        pssenior {
            res.srcDirs = ['src/pssenior/res']
        }
        railwaybalabhavan {
            res.srcDirs = ['src/railwaybalabhavan/res']
        }
    }
}

dependencies {
    // The version of react-native is set by the React Native Gradle Plugin
    implementation("com.facebook.react:react-android")

    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }
}
